/*
 *	Turpial JS Templating Engine Library V. 1.0.0
 *	Copyright Yorman Maricuto, May 2019.  
 * 	License MIT.
 * 	Social Media/Contact:
 *	@twitter: @MaricutoYorman
 *	@Instagram: maricuto
 *	@email: yerikmiller@gmail.com
 *	@number: +584267886875
 *	@github: yerikmiller
 * 	@project: guide | github.
 *	Templating engine for user interfaces (UI).
 *	The Turpial is the Venezuela's national bird.
 *
 * 	MADE IN: V E N E Z U E L A.
 * 	@Minified Version. V. 1.0.0
 *
*/
class Turpial{constructor(e={}){this.birds=[],this.v={un:(e,t="")=>void 0===e?t:e},this.searchStr=((e,t,i=!1)=>{let r=e.search(t);return-1!==r&&(!0!==i||r)}),this.replacement=((e,t,i)=>e.split(t).join(i)),this.find=(e=>"string"==typeof e?document.getElementById(e):e),this.autoloader=this.v.un(e.autoloader,!1),this.components_folder=this.v.un(e.components_folder,""),this.cache=this.v.un(e.cache,"default"),this.public_path=this.v.un(e.public_path,""),this.core_path=this.v.un(e.core_path,""),this.folder=this.v.un(e.core_path,"/turpial/"),this.loader={},this.loader.show=this.v.un(e.loaderShow,null),this.loader.hide=this.v.un(e.loaderHide,null),this.views={},this.resources={},this.component={set:e=>{let t=e.tag;var i=this.v.un(e.extends,null);void 0===window.customElements.get(t)&&(null!==i&&(i={extends:i}),window.customElements.define(t,class extends HTMLElement{constructor(i=e.props){super((e=>{var i=t=>{return[...document.getElementsByTagName(t)].forEach(function(t){e(t)}),"ready"};if(window.addEventListener("load",()=>i(t)),"complete"===document.readyState)return i(t)})(i))}},i))}},this.view={application:this},this.models={},this.models.sources={},this.controller={},this.modules={},this.filesLoaded={},this.inject=(async e=>new Promise(t=>{for(const t of e)document.head.appendChild(this.filesLoaded[t])})),this.models.fetch=(e=>{let t=this.v.un(e.type,"script");if(void 0===e.ready&&(e.ready=(()=>{})),"string"==typeof e.file)var i=[e.file];else i=e.file;let r=this;document.head;const s=[];let o=[];e.getString=(e=>e.clone().text()),e.fetching=(async i=>{void 0!==r.filesLoaded[i]&&"script"===t&&r.filesLoaded[i].remove(),window.fetch(i,{cache:r.cache}).then(t=>{if("function"==typeof e.error&&200!==t.status)return e.error(t.status);200===t.status&&e.getString(t).then(e=>{o.push(e);var t=document.createElement("script");t.text=e,r.filesLoaded[i]=t,s.push(i)})})}),(i=>{for(const t of i)e.fetching(t);var n=0;let a=setInterval(()=>{let l=!1;if(1e4===(n+=70)&&(l=!0,console.warn("Â¡Impossible to load all files.")),s.length===i.length||!0===l){if(clearInterval(a),"script"===t)return r.inject(i),void e.ready();if("text"===t)return void e.ready(o)}},70)})(i)}),this.fetch=(e=>this.models.fetch(e)),this.include=(e=>this.models.fetch(e)),this.controller.views={application:this,folder:`${this.folder}views/`,ext:".turpial.js",path(e){var t=e.views.split("/"),i=this.folder;if(1===t.length){var r=t[0];return i+=`${r}${this.ext}`,this.application.resources[r]={},i}var s=t.pop(),o=t.pop();r=s;return this.application.resources[o]={},this.application.resources[o][r]={},0===t.length?i+=`${o}/${r}${this.ext}`:(t.forEach(function(e){i+=`${e}/`}),i+=`${o}/${r}${this.ext}`),i}},this.view.load=((e={folder:this.components_folder,ready:()=>{}})=>{var t=".turpial.js",i=`${this.folder}${e.folder}${this.app.controller_name}`,r=this.app.parameters;if("index"===this.app.controller_name)var s=`${i}${t}`;else if(0===r.length)s=`${i}/${this.app.action_name}/index${t}`;else{s=`${i}/${this.app.action_name}`;r.forEach(function(e){s+=`/${e}`}),s+=t}var o={file:s,ready:()=>{e.ready()}};"function"==typeof e.error&&(o.error=(t=>{e.error(t)})),this.fetch(o),this.DataView=o}),this.controller.routes={set:()=>{var e=this;e.app={};var t=window.location.href.split("?"),i=(t=(t=(t=t[0]).split("#"))[0].split(this.public_path))[1].split("/"),r=0,s=0;e.app.parameters=[],i.forEach(function(t){""!=t&&(0===r&&(e.app.controller_name=t),1===r?e.app.action_name=t:r>1&&(e.app.parameters[s++]=t),r++)}),void 0===e.app.controller_name&&(e.app.controller_name="index")},change:e=>{var t=window.location.href,i=(t=(t=(t=(t=t.split("#"))[0]).split("?"))[0]).split("/");i=""===i.pop()?"":"/",!0===this.searchStr(e.path,"http")&&(t=""),window.history.pushState(this.v.un(e.object),this.v.un(e.title),this.v.un(`${t}${i}${e.path}`)),this.routes=this.controller.routes.set(),this.modules.load()}},this.router=(e=>{this.controller.routes.change(e)}),this.routes=this.controller.routes.set,this.routes(),this.controller.components={},this.views.get=(e=>{if("object"==typeof e){"string"==typeof e.views&&(e.views=[e.views]);var t=[],i=this.controller.views;e.views.forEach(function(r,s){e.views=r,t[s]=i.path(e)}),this.fetch({file:t,ready:e.ready})}}),this.url={},this.modules={},this.modules.load=(()=>{let e=this.app.controller_name,t=this.app.action_name;this.modules[e]=this.v.un(this.modules[e],""),"function"!=typeof this.modules[e].self?"function"!=typeof this.modules[e][t]?this.view.load():this.modules[e][t](()=>{this.view.load()}):this.modules[e].self(()=>{this.view.load()})}),!0===e.autoloader&&(window.addEventListener("load",()=>{this.modules.load()}),window.onpopstate=(e=>{this.controller.routes.set(),this.modules.load()}))}map(e,t=[]){var i=this.birds[e];if("object"==typeof e?i=e:void 0===i&&(i=this.find(e)),"object"==typeof t){if(void 0===t[0])return i;i=i.children,t.forEach(function(e,r){i=void 0===t[r+1]?i[e]:i[e].children})}return i}createMap(e){var t=(e=this.find(e)).getAttribute("id");if(void 0!==t){var i=document.getElementById(t);this.birds[t]=i}}read(e,t=[]){return this.map(e,t)}selectorApp(e,t=[]){return"object"==typeof t&&!0===Number.isInteger(t[0])?this.map(e,t):t}delete(e){(e=this.find(e)).remove()}update(e,t=null,i="replace-selector",r=!0){if("string"==typeof t)var s=this.render(t),o=t;else s=t;if(null===s){var n=!1;s=t}else n=!0;var a=e;!0===r&&(i="replace-selector");var l=!1,h=a.parentNode;if("before"===i)h.insertBefore(s,a),l=s;else if("after"===i)h.insertBefore(s,a.nextSibling),l=s;else if("replace-selector"===i)h.replaceChild(s,a),l=s;else{if("inner"!==i)return console.warn("error-on-placement"),!1;!0===n?a.innerHTML=o:a.innerText=s,l=a}let c=a;return this.createMap(c),l}insert(e,t,i="inner"){return e=this.find(e),this.update(e,t,i,!1)}render(e){var t=document.createElement("template");return t.innerHTML=e,t=t.content.firstElementChild}mount(e,t){if("string"==typeof t)t=this.render(t);if(null===t)return void console.warn("need to be HTML string or object");let i=(e=this.find(e)).appendChild(t),r=e;return this.createMap(r),i}settings(e){if(void 0!==e[0])return"";var t=[],i=0;Object.values(e).forEach(function(e){t[i++]=e});var r=[];i=0;Object.keys(e).forEach(function(e){r[i++]=e});var s="";i=0;return r.forEach(function(e,i){s+=` ${e}="${t[i]}"`}),s}createTag(e,t="",i=""){if("object"==typeof t)t=this.settings(t);let r=`<${e}${t}>`;return r+=i,"br"!==e&&(r+=`</${e}>`),r}html(e,t,i){"code"===e&&(i=this.replacement(i,"<","&lt;"),i=this.replacement(i,">","&gt;"),i=this.replacement(i," ","&nbsp;"));if(void 0===i)i=t,t="";if("object"==typeof i&&void 0!==i[0]){var r="";i.forEach(function(e,t){r+=`${e}`});var s=this.createTag(e,t,r)}else if("object"==typeof i)t=i,s=this.createTag(e,t,i="");else s=this.createTag(e,t,i);return s}el(e,t,i){return this.html(e,t,i)}}
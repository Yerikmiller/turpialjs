/*
 *	Turpial JS Templating Engine Library V. 1.0.0
 *	Copyright Yorman Maricuto, May 2019.  
 * 	License MIT.
 * 	Social Media/Contact:
 *	@twitter: @MaricutoYorman
 *	@Instagram: maricuto
 *	@email: yerikmiller@gmail.com
 *	@number: +584267886875
 *	@github: yerikmiller
 * 	@project: guide | github.
 *	Micro Framework to create web components and a templating engine for user interfaces (UI).
 *	Turpial: The Venezuela's national bird.
 *
 * 	MADE IN: V E N E Z U E L A.
 * 	@Development Version. V. 1.0.0
 *
*/
class Turpial{constructor(e={}){this.birds=[],this.un=((e,t="")=>void 0===e?t:e),this.searchStr=((e,t,r=!1)=>{let o=e.search(t);return-1!==o&&(!0!==r||o)}),this.replacement=((e,t,r)=>e.split(t).join(r)),this.find=(e=>"string"==typeof e?document.getElementById(e):e),this.ext=".turpial.js",this.autoloader=this.un(e.autoloader,!1),this.autoloader_folder=this.un(e.autoloader_folder,""),this.cache=this.un(e.cache,"default"),this.public_path=this.un(e.public_path,""),this.core_path=this.un(e.core_path,""),this.folder=this.un(e.core_path,"/turpial/"),this.loader={},this.loader.show=this.un(e.loaderShow,null),this.loader.hide=this.un(e.loaderHide,null),this.views={},this.statusResources="loaded",this.resources={},this.myComponents=[],this.component={applyProps:(e,t)=>{const r=()=>{const r=document.querySelectorAll(e);Array.prototype.slice.call(r).forEach(function(e){t(e)})},o=()=>{if("loading"===this.statusResources)var e=0,t=setInterval(()=>e>6e3?(console.warn("error loading resources and applying components"),void clearInterval(t)):(e+=20,"loaded"===this.statusResources?(clearInterval(t),void r()):void 0),20);else r()};window.addEventListener("load",()=>{o()}),"complete"!==document.readyState||o()},set:e=>{const t=this,r=t.component;var o=e.props,s=e.tag;t.myComponents.push({tag:s,props:o});var i=t.un(e.extends,null);if(null!==i&&(i={extends:i}),void 0===window.customElements)return t.component.olderVerBrow=(()=>{}),void r.applyProps(s,o);void 0===window.customElements.get(s)&&window.customElements.define(s,class extends HTMLElement{constructor(t=e.props){super((e=>{r.applyProps(s,e)})(t))}},i)}},this.view={},this.models={},this.models.sources={},this.controller={},this.urls={},this.filesLoaded={},this.inject=(e=>{for(const t of e)document.head.appendChild(this.filesLoaded[t])}),this.models.fetch=(e=>{let t=this,o=t.un(e.type,"script");const s=t.un(e.options,{"Cache-Control":t.cache,Accept:"text/html"});if(void 0===e.ready&&(e.ready=(()=>{})),"string"==typeof e.file)var i=[e.file];else i=e.file;document.head;const n=[];let a=[];e.getString=(e=>e.clone().text()),e.fetching=(i=>{void 0!==t.filesLoaded[i]&&"script"===o&&t.filesLoaded[i].remove();var l=new XMLHttpRequest;l.open("GET",i,!0);const c=[],h=[];for(var d in s)h.push(s[d]);Object.keys(s).forEach(function(e,t){c.push([e,h[t]])}),c.forEach(function(e){l.setRequestHeader(e[0],e[1])}),l.onload=function(){if(l.status>=200&&l.status<400){var o=l.responseText;a.push(o);var s=document.createElement("script");s.text=o,t.filesLoaded[i]=s,n.push(i)}else if("function"==typeof e.error&&200!==r.status)return e.error(l.status)},l.send()}),t.statusResources="loading",(r=>{for(const t of r)e.fetching(t);var s=0;let i=setInterval(()=>{let l=!1;if(1e4===(s+=70)&&(l=!0,console.warn("Â¡Impossible to load all files.")),n.length===r.length||!0===l)return clearInterval(i),"script"===o?(t.inject(r),e.ready()):"text"===o&&e.ready(a),void(t.statusResources="loaded")},70)})(i)}),this.fetch=(e=>this.models.fetch(e)),this.include=(e=>this.models.fetch(e)),this.controller.views={path:e=>{const t=this.ext;var r=`${this.folder}views/`,o=e.views,s=this.resources,i=o.split("/"),n=r;if(1===i.length){var a=i[0];return n+=`${a}${t}`,s[a]={},n}var l=i.pop(),c=i.pop();a=l;return s[c]={},s[c][a]={},0===i.length?n+=`${c}/${a}${t}`:(i.forEach(function(e){n+=`${e}/`}),n+=`${c}/${a}${t}`),n}},this.view.load=((e={folder:this.autoloader_folder,ready:()=>{}})=>{const t=this.ext,r=this.app.parameters,o=this.app.controller_name,s=this.app.action_name,i=`${this.folder}${e.folder}${o}`;if("index"===o)var n=`${i}${t}`;else if(0===r.length&&"index"!==o&&void 0===s)n=`${i}/index${t}`;else if(0===r.length&&"undefined"!==s)n=`${i}/${s}/index${t}`;else{n=`${i}/${s}`;r.forEach(function(e){n+=`/${e}`}),n+=t}var a={file:n,ready:()=>{e.ready()}};"function"==typeof e.error&&(a.error=(t=>{e.error(t)})),this.fetch(a),this.DataView=a}),this.controller.routes={set:()=>{const e=this;e.app={};var t=window.location.href.split("?");let r=(t=(t=t[0]).split("#"))[0].search(e.public_path);if(r>0){var o=(t=t[0].substr(r+e.public_path.length)).split("/"),s=0,i=0;e.app.parameters=[],o.forEach(function(t){""!=t&&(0===s&&(e.app.controller_name=t),1===s?e.app.action_name=t:s>1&&(e.app.parameters[i++]=t),s++)}),void 0===e.app.controller_name&&(e.app.controller_name="index")}else console.warn("bad_public_path_name")},change:e=>{var t=window.location.href,r=(t=(t=(t=(t=t.split("#"))[0]).split("?"))[0]).split("/");r=""===r.pop()?"":"/",!0===this.searchStr(e.path,"http")&&(t=""),window.history.pushState(this.un(e.object),"",this.un(`${t}${r}${e.path}`)),this.controller.routes.set(),this.urls.load();let o=this.un(e.title,!1);"string"==typeof o&&(document.title=o)},go:e=>{if("number"==typeof e)window.history.go(e);else if("back"===e)window.history.back();else{if("forward"!==e)return;window.history.forward()}this.controller.routes.set(),this.urls.load()}},this.router=(e=>{"number"!=typeof e&&"string"!=typeof e?this.controller.routes.change(e):this.controller.routes.go(e)}),this.routes=this.controller.routes.set,this.routes(),this.controller.components={},this.views.get=(e=>{if("object"==typeof e){"string"==typeof e.views&&(e.views=[e.views]);var t=[],r=this.controller.views;e.views.forEach(function(o,s){e.views=o,t[s]=r.path(e)}),this.fetch({file:t,ready:e.ready})}}),this.urls={},this.urls.load=(()=>{const e=this,t=e.app.controller_name,r=e.app.action_name,o=e.app.parameters;let s=e.un(e.urls[t],!1);if(!1===s)return void e.view.load();e.un(s.loadController,!0);let i=e.un(s.loadAction,!0),n=e.un(s.loadParameters,1e3),a=e.un(e.urls[t][r],!1);return"function"==typeof s.self?"function"==typeof a&&!0===i?o.length>n?void s.self(()=>{a(()=>{})}):void s.self(()=>{a(()=>{e.view.load()})}):!1===i&&"string"==typeof r?void s.self(()=>{a(()=>{})}):void s.self(()=>{e.view.load()}):void 0}),!0===e.autoloader&&(window.addEventListener("load",()=>{this.urls.load()}),window.onpopstate=(e=>{this.controller.routes.set(),this.urls.load(),function(){void 0===window.customElements&&Array.prototype.slice.call(this.myComponents).forEach(function(e){this.component.set({tag:e.tag,props:e.props})})}()}))}map(e,t=[]){var r=this.birds[e];if("object"==typeof e?r=e:void 0===r&&(r=this.find(e)),"object"==typeof t){if(void 0===t[0])return r;r=r.children,t.forEach(function(e,o){r=void 0===t[o+1]?r[e]:r[e].children})}return r}createMap(e){var t=(e=this.find(e)).getAttribute("id");if(void 0!==t){var r=document.getElementById(t);this.birds[t]=r}}read(e,t=[]){return this.map(e,t)}selectorApp(e,t=[]){return"object"==typeof t&&!0===Number.isInteger(t[0])?this.map(e,t):t}delete(e){(e=this.find(e)).remove()}update(e,t=null,r="replace-selector",o=!0){if("string"==typeof t)var s=this.render(t),i=t;else s=t;if(null===s){var n=!1;s=t}else n=!0;var a=e;!0===o&&(r="replace-selector");var l=!1,c=a.parentNode;if("before"===r)c.insertBefore(s,a),l=s;else if("after"===r)c.insertBefore(s,a.nextSibling),l=s;else if("replace-selector"===r)c.replaceChild(s,a),l=s;else{if("inner"!==r)return console.warn("error-on-placement"),!1;!0===n?a.innerHTML=i:a.innerText=s,l=a}let h=a;return this.createMap(h),l}insert(e,t,r="inner"){return e=this.find(e),this.update(e,t,r,!1)}render(e){var t=document.createElement("template");return t.innerHTML=e,t=t.content.firstElementChild}mount(e,t){if("string"==typeof t)t=this.render(t);if(null===t)return void console.warn("need to be HTML string or object");let r=(e=this.find(e)).appendChild(t),o=e;return this.createMap(o),r}settings(e){if(void 0===e[0]){var t=[],r=0,o=[];for(var s in e)o.push(e[s]);o.forEach(function(e){t[r++]=e});var i=[];r=0;Object.keys(e).forEach(function(e){i[r++]=e});var n="";r=0;return i.forEach(function(e,r){n+=` ${e}="${t[r]}"`}),n}}createTag(e,t="",r=""){"object"==typeof t&&(t=this.settings(t));let o=`<${e}${t}>`;return o+=r,"br"!==e&&(o+=`</${e}>`),o}html(e,t,r){const o=this.replacement,s=this;if("code"===e&&(r=o(r,"<","&lt;"),r=o(r,">","&gt;"),r=o(r," ","&nbsp;")),void 0===r)r=t,t="";if("object"==typeof r&&void 0!==r[0]){var i="";r.forEach(function(e,t){i+=`${e}`});var n=s.createTag(e,t,i)}else if("object"==typeof r)t=r,n=s.createTag(e,t,r="");else n=s.createTag(e,t,r);return n}el(e,t,r){return this.html(e,t,r)}}
/*
 *	Turpial JS Templating Engine Library V. 1.0.0
 *	Copyright Yorman Maricuto, May 2019.  
 * 	License MIT.
 * 	Social Media/Contact:
 *	@twitter: @MaricutoYorman
 *	@Instagram: maricuto
 *	@email: yerikmiller@gmail.com
 *	@number: +584267886875
 *	@github: yerikmiller
 * 	@project: guide | github.
 *	Micro Framework to create web components and a templating engine for user interfaces (UI).
 *	Turpial: The Venezuela's national bird.
 *
 * 	MADE IN: V E N E Z U E L A.
 * 	@Development Version. V. 1.0.0
 *
*/
class Turpial{constructor(e={}){this.birds=[],this.un=((e,t="")=>void 0===e?t:e),this.searchStr=((e,t,o=!1)=>{let r=e.search(t);return-1!==r&&(!0!==o||r)}),this.replacement=((e,t,o)=>e.split(t).join(o)),this.find=(e=>"string"==typeof e?document.getElementById(e):e),this.ext=".turpial.js",this.autoloader=this.un(e.autoloader,!1),this.autoloader_folder=this.un(e.autoloader_folder,""),this.cache=this.un(e.cache,"public"),this.public_path=this.un(e.public_path,""),this.core_path=this.un(e.core_path,""),this.folder=this.un(e.core_path,"/turpial/"),this.loader={},this.loader.show=this.un(e.loaderShow,null),this.loader.hide=this.un(e.loaderHide,null),this.views={},this.statusResources="loaded",this.resources={},this.myComponents=[],this.component={applyProps:(e,t)=>{const o=()=>{const o=document.querySelectorAll(e);Array.prototype.slice.call(o).forEach(function(e){t(e)})},r=()=>{if("loading"===this.statusResources)var e=0,t=setInterval(()=>e>6e3?(console.warn("error loading resources and applying components"),void clearInterval(t)):(e+=20,"loaded"===this.statusResources?(clearInterval(t),void o()):void 0),20);else o()};window.addEventListener("load",()=>{r()}),"complete"!==document.readyState||r()},set:e=>{const t=this,o=t.component;var r=e.props,s=e.tag;t.myComponents.push({tag:s,props:r});var i=t.un(e.extends,null);if(null!==i&&(i={extends:i}),void 0===window.customElements)return t.component.olderVerBrow=(()=>{}),void o.applyProps(s,r);void 0===window.customElements.get(s)&&window.customElements.define(s,class extends HTMLElement{constructor(t=e.props){super((e=>{o.applyProps(s,e)})(t))}},i)}},this.view={},this.models={},this.models.sources={},this.controller={},this.urls={},this.filesLoaded={},this.inject=(e=>{for(const t of e)document.head.appendChild(this.filesLoaded[t])}),this.models.fetch=(e=>{let t=this,o=t.un(e.type,"script");const s=t.un(e.options,null),i=t.un(e.method,"GET");void 0!==e.data&&(e.file=e.data),void 0!==e.files&&(e.file=e.files);var n=e.file;void 0===e.ready&&(e.ready=(()=>{})),"string"==typeof n&&(n=[n]);document.head;const a=[];let l=[];e.getString=(e=>e.clone().text()),e.fetching=(n=>{void 0!==t.filesLoaded[n]&&"script"===o&&t.filesLoaded[n].remove();var c=new XMLHttpRequest;c.open(i,n,!0);const h=[],d=[];if(null!==s){for(var p in s)d.push(s[p]);Object.keys(s).forEach(function(e,t){h.push([e,d[t]])}),h.forEach(function(e){c.setRequestHeader(e[0],e[1])})}c.onload=function(){if(c.status>=200&&c.status<400){var o=c.responseText;l.push(o);var s=document.createElement("script");s.text=o,t.filesLoaded[n]=s,a.push(n)}else if("function"==typeof e.error&&200!==r.status)return e.error(c.status)},c.send()}),t.statusResources="loading",(r=>{for(const t of r)e.fetching(t);var s=0;let i=setInterval(()=>{let n=!1;if(1e4===(s+=70)&&(n=!0,console.warn("Â¡Impossible to load all files.")),a.length!==r.length&&!0!==n);else{if(clearInterval(i),"script"===o)t.inject(r),e.ready();else if("text"===o){var l=[];for(var c of r)l.push(t.filesLoaded[c].innerHTML);e.ready(l)}t.statusResources="loaded"}},70)})(n)}),this.fetch=(e=>this.models.fetch(e)),this.include=(e=>this.models.fetch(e)),this.controller.views={path:e=>{const t=this.ext;var o=`${this.folder}views/`,r=e.views,s=this.resources,i=r.split("/"),n=o;if(1===i.length){var a=i[0];return n+=`${a}${t}`,s[a]={},n}var l=i.pop(),c=i.pop();a=l;return s[c]={},s[c][a]={},0===i.length?n+=`${c}/${a}${t}`:(i.forEach(function(e){n+=`${e}/`}),n+=`${c}/${a}${t}`),n}},this.view.load=((e={folder:this.autoloader_folder,ready:()=>{}})=>{const t=this.ext,o=this.app.parameters,r=this.app.controller_name,s=this.app.action_name,i=`${this.folder}${e.folder}${r}`;if("index"===r)var n=`${i}${t}`;else if(0===o.length&&"index"!==r&&void 0===s)n=`${i}/index${t}`;else if(0===o.length&&"undefined"!==s)n=`${i}/${s}/index${t}`;else{n=`${i}/${s}`;o.forEach(function(e){n+=`/${e}`}),n+=t}var a={file:n,ready:()=>{e.ready()}};"function"==typeof e.error&&(a.error=(t=>{e.error(t)})),this.fetch(a),this.DataView=a}),this.controller.routes={set:()=>{const e=this;e.app={};var t=window.location.href.split("?");let o=(t=(t=t[0]).split("#"))[0].search(e.public_path);if(o>0){var r=(t=t[0].substr(o+e.public_path.length)).split("/"),s=0,i=0;e.app.parameters=[],r.forEach(function(t){""!=t&&(0===s&&(e.app.controller_name=t),1===s?e.app.action_name=t:s>1&&(e.app.parameters[i++]=t),s++)}),void 0===e.app.controller_name&&(e.app.controller_name="index")}else console.warn("bad_public_path_name")},change:e=>{var t=window.location.href,o=(t=(t=(t=(t=t.split("#"))[0]).split("?"))[0]).split("/");o=""===o.pop()?"":"/",!0===this.searchStr(e.path,"http")&&(t=""),window.history.pushState(this.un(e.object),"",this.un(`${t}${o}${e.path}`)),this.controller.routes.set(),this.urls.load();let r=this.un(e.title,!1);"string"==typeof r&&(document.title=r)},go:e=>{if("number"==typeof e)window.history.go(e);else if("back"===e)window.history.back();else{if("forward"!==e)return;window.history.forward()}this.controller.routes.set(),this.urls.load()}},this.router=(e=>{"number"!=typeof e&&"string"!=typeof e?this.controller.routes.change(e):this.controller.routes.go(e)}),this.routes=this.controller.routes.set,this.routes(),this.controller.components={},this.views.get=(e=>{if("object"==typeof e){"string"==typeof e.views&&(e.views=[e.views]);var t=[],o=this.controller.views;e.views.forEach(function(r,s){e.views=r,t[s]=o.path(e)}),Object.assign(e,{file:t,ready:e.ready}),this.fetch(e)}}),this.urls={},this.urls.load=(()=>{const e=this,t=e.app.controller_name,o=e.app.action_name,r=e.app.parameters;let s=e.un(e.urls[t],!1);if(!1===s)return void e.view.load();e.un(s.loadController,!0);let i=e.un(s.loadAction,!0),n=e.un(s.loadParameters,1e3),a=e.un(e.urls[t][o],!1);return"function"==typeof s.self?"function"==typeof a&&!0===i?r.length>n?void s.self(()=>{a(()=>{})}):void s.self(()=>{a(()=>{e.view.load()})}):!1===i&&"string"==typeof o?void s.self(()=>{a(()=>{})}):void s.self(()=>{e.view.load()}):void 0}),!0===e.autoloader&&(window.addEventListener("load",()=>{this.urls.load()}),window.onpopstate=(e=>{this.controller.routes.set(),this.urls.load(),function(){void 0===window.customElements&&Array.prototype.slice.call(this.myComponents).forEach(function(e){this.component.set({tag:e.tag,props:e.props})})}()}))}map(e,t=[]){var o=this.birds[e];if("object"==typeof e?o=e:void 0===o&&(o=this.find(e)),"object"==typeof t){if(void 0===t[0])return o;o=o.children,t.forEach(function(e,r){o=void 0===t[r+1]?o[e]:o[e].children})}return o}createMap(e){var t=(e=this.find(e)).getAttribute("id");if(void 0!==t){var o=document.getElementById(t);this.birds[t]=o}}read(e,t=[]){return this.map(e,t)}selectorApp(e,t=[]){return"object"==typeof t&&!0===Number.isInteger(t[0])?this.map(e,t):t}delete(e){(e=this.find(e)).remove()}update(e,t=null,o="replace-selector",r=!0){if("string"==typeof t)var s=this.render(t),i=t;else s=t;if(null===s){var n=!1;s=t}else n=!0;var a=e;!0===r&&(o="replace-selector");var l=!1,c=a.parentNode;if("before"===o)c.insertBefore(s,a),l=s;else if("after"===o)c.insertBefore(s,a.nextSibling),l=s;else if("replace-selector"===o)c.replaceChild(s,a),l=s;else{if("inner"!==o)return console.warn("error-on-placement"),!1;!0===n?a.innerHTML=i:a.innerText=s,l=a}let h=a;return this.createMap(h),l}insert(e,t,o="inner"){return e=this.find(e),this.update(e,t,o,!1)}render(e){var t=document.createElement("template");return t.innerHTML=e,t=t.content.firstElementChild}mount(e,t){if("string"==typeof t)t=this.render(t);if(null===t)return void console.warn("need to be HTML string or object");let o=(e=this.find(e)).appendChild(t),r=e;return this.createMap(r),o}settings(e){if(void 0===e[0]){var t=[],o=0,r=[];for(var s in e)r.push(e[s]);r.forEach(function(e){t[o++]=e});var i=[];o=0;Object.keys(e).forEach(function(e){i[o++]=e});var n="";o=0;return i.forEach(function(e,o){n+=` ${e}="${t[o]}"`}),n}}createTag(e,t="",o=""){"object"==typeof t&&(t=this.settings(t));let r=`<${e}${t}>`;return r+=o,"br"!==e&&(r+=`</${e}>`),r}html(e,t,o){const r=this.replacement,s=this;if("code"===e&&(o=r(o,"<","&lt;"),o=r(o,">","&gt;"),o=r(o," ","&nbsp;")),void 0===o)o=t,t="";if("object"==typeof o&&void 0!==o[0]){var i="";o.forEach(function(e,t){i+=`${e}`});var n=s.createTag(e,t,i)}else if("object"==typeof o)t=o,n=s.createTag(e,t,o="");else n=s.createTag(e,t,o);return n}el(e,t,o){return this.html(e,t,o)}}
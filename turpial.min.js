/*
 *  Turpial JS Library V. 1.0.0
 *  Copyright Yorman Maricuto, May 2019.  
 *  License MIT.
 *  Social Media/Contact:
 *  @twitter: @MaricutoYorman
 *  @Instagram: maricuto
 *  @email: yerikmiller@gmail.com
 *  @number: +584267886875
 *  @github: yerikmiller
 *  @project: guide | github.
 *  Micro Library to create web components with a simple template engine for user interfaces (UI).
 *  Easy XHR connections (POST & GET), inject Scripts and CSS whenever you want and make XHR requests.
 *  Turpial: The Venezuela's national bird.
 *
 *  MADE IN: V E N E Z U E L A.
 *
*/
class Turpial{constructor(e={}){this.birds=[],this.un=((e,t="")=>void 0===e?t:e),this.searchStr=((e,t,o=!1)=>{let s=e.search(t);return-1!==s&&(!0!==o||s)}),this.replacement=((e,t,o)=>e.split(t).join(o)),this.find=(e=>"string"==typeof e?document.getElementById(e):e),this.ext=".turpial.js",this.allowStateEvents=this.un(e.allowStateEvents,!1),this.autoloader=this.un(e.autoloader,!1),this.autoloader_folder=this.un(e.autoloader_folder,""),this.cache=this.un(e.cache,"public"),this.public_path=this.un(e.public_path,""),this.core_path=this.un(e.core_path,""),this.folder=this.un(e.core_path,"/turpial/"),this.loader={},this.httpRequests=[],this.loader.show=this.un(e.loaderShow,null),this.loader.hide=this.un(e.loaderHide,null),this.views={},this.statusResources="loaded",this.resources={},this.myComponents=[],this.random_string=(e=>{void 0===e&&(e=6);for(var t="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=o.length,i=0;i<e;i++)t+=o.charAt(Math.floor(Math.random()*s));return t}),this.selectData=((e,t,o,s)=>{s=turpial.un(s,!1);var i="";return e.forEach(function(e,r){if(e[t]==o)return!0===s?void(i=r):void(i=e)}),i}),this.component={applyProps:(e,t)=>{const o=()=>{const o=document.querySelectorAll(e);Array.prototype.slice.call(o).forEach(function(e){t(e)})},s=()=>{if("loading"===this.statusResources)var e=0,t=setInterval(()=>e>6e3?(console.warn("error loading resources and applying components"),void clearInterval(t)):(e+=20,"loaded"===this.statusResources?(clearInterval(t),void o()):void 0),20);else o()};window.addEventListener("load",()=>{s()}),"complete"!==document.readyState||s()},set:e=>{const t=this,o=t.component;var s=e.props,i=e.tag;t.myComponents.push({tag:i,props:s});var r=t.un(e.extends,null);if(null!==r&&(r={extends:r}),void 0===window.customElements)return t.component.olderVerBrow=(()=>{}),void o.applyProps(i,s);void 0===window.customElements.get(i)&&window.customElements.define(i,class extends HTMLElement{constructor(t=e.props){super((e=>{o.applyProps(i,e)})(t))}},r)}},this.view={},this.models={},this.models.sources={},this.controller={},this.urls={},this.filesLoaded={},this.inject=(e=>{for(const t of e)"STYLE"===this.filesLoaded[t].tagName&&(this.filesLoaded[t].innerHTML=this.filesLoaded[t].text),document.head.appendChild(this.filesLoaded[t])}),this.models.fetch=(e=>{let t=this,o=e.type||"script";const s=t.un(e.cancelOnResend,null),i=t.un(e.options,null),r=t.un(e.method,"GET");e.url=e.url||[],e.file=e.file||e.url,e.files=e.files||e.file;var n=e.files;void 0===e.ready&&(e.ready=(()=>{})),"string"==typeof n&&(n=[n]);document.head;const l=[],a=[];let h=[];e.getString=(e=>e.clone().text()),e.fetching=(n=>{void 0!==t.filesLoaded[n]&&"script"===o&&t.filesLoaded[n].remove();var d=new XMLHttpRequest;d.open(r,n,!0);const c=[],u=[];if(null!==i){for(var p in i)u.push(i[p]);Object.keys(i).forEach(function(e,t){c.push([e,u[t]])}),c.forEach(function(e){d.setRequestHeader(e[0],e[1])})}if(d.onload=function(){if(d.status>=200&&d.status<400){var s,i=d.responseText;h.push(i),s="script"===o||"style"===o||"link"===o?o:"script";var r=document.createElement(s);"style"===o?r.type="text/css":"link"===o&&(r.rel="stylesheet",r.media="all",r.href=n),r.text=i,t.filesLoaded[n]=r,l.push(n)}else if("function"==typeof e.onerror&&d.status>=400)return e.onerror(d.status)},d.onerror=function(){t.filesLoaded[n]="",l.push("unloaded:"+n),a.push(n)},!0===s){let o="rq_"+t.un(e.id,t.random_string(4));if(void 0!==t.httpRequests[o])try{t.httpRequests[o].abort()}catch(e){console.warn("unable to cancel request.")}t.httpRequests[o]=d}"POST"!==r?d.send():d.send(e.data)}),t.statusResources="loading",(s=>{for(const t of s)e.fetching(t);var i=0;let r=setInterval(()=>{let n=!1;if(1e4===(i+=70)&&(n=!0,console.warn("Â¡Impossible to load all files.")),l.length!==s.length&&!0!==n);else{if(clearInterval(r),"script"===o||"style"===o||"link"===o)t.inject(s),e.ready();else if("text"===o){var a=[];for(var h of s)a.push(t.filesLoaded[h].innerHTML);e.ready(a)}t.statusResources="loaded"}},70)})(n)}),this.fetch=(e=>this.models.fetch(e)),this.include=(e=>this.models.fetch(e)),this.linkCSS=(e=>(e.type="link",this.models.fetch(e))),this.includeCSS=(e=>(e.type="style",this.models.fetch(e))),this.controller.views={path:e=>{const t=this.ext;var o=`${this.folder}views/`,s=e.views,i=this.resources,r=s.split("/"),n=o;if(1===r.length){var l=r[0];return n+=`${l}${t}`,i[l]={},n}var a=r.pop(),h=r.pop();l=a;return i[h]={},i[h][l]={},0===r.length?n+=`${h}/${l}${t}`:(r.forEach(function(e){n+=`${e}/`}),n+=`${h}/${l}${t}`),n}},this.view.load=(e=>{e=e||{folder:this.autoloader_folder,ready:()=>{}};const t=this.ext,o=this.app.parameters,s=this.app.controller_name,i=this.app.action_name,r=`${this.folder}${e.folder}${s}`;if(e.module=turpial.un(e.module,null),"index"===s)var n=`${r}${t}`;else if(0===o.length&&"index"!==s&&void 0===i)n=`${r}/index${t}`;else if(0===o.length&&"undefined"!==i)n=`${r}/${i}/index${t}`;else{n=`${r}/${i}`;o.forEach(function(e){n+=`/${e}`}),n+=t}"string"==typeof e.module&&(e.ext=e.ext||t,n=this.core_path+e.module+e.ext);var l={file:n,options:e.options||{},ready:()=>{e.ready()}};"function"==typeof e.error&&(l.error=(t=>{e.error(t)})),this.DataView=l,""!==e.module&&!1!==e.module&&this.fetch(l)}),this.controller.routes={set:()=>{const e=this;e.app={};var t=window.location.href.split("?");let o=(t=(t=t[0]).split("#"))[0].search(e.public_path);if(o>0){var s=(t=t[0].substr(o+e.public_path.length)).split("/"),i=0,r=0;e.app.parameters=[],s.forEach(function(t){""!=t&&(0===i&&(e.app.controller_name=t),1===i?e.app.action_name=t:i>1&&(e.app.parameters[r++]=t),i++)}),void 0===e.app.controller_name&&(e.app.controller_name="index")}else console.warn("bad_public_path_name")},change:e=>{var t=window.location.href,o=(t=(t=(t=(t=t.split("#"))[0]).split("?"))[0]).split("/");o=""===o.pop()?"":"/",!0===this.searchStr(e.path,"http")&&(t=""),window.history.pushState(this.un(e.object),"",this.un(`${t}${o}${e.path}`)),this.controller.routes.set(),this.urls.load(e);let s=this.un(e.title,!1);"string"==typeof s&&(document.title=s)},go:e=>{if("number"==typeof e)window.history.go(e);else if("back"===e)window.history.back();else{if("forward"!==e)return;window.history.forward()}this.controller.routes.set(),this.urls.load()}},this.router=(e=>{"number"!=typeof e&&"string"!=typeof e?(this.controller.routes.change(e),this.stateEvent()):this.controller.routes.go(e)}),this.routes=this.controller.routes.set,this.routes(),this.controller.components={},this.views.get=(e=>{if("object"==typeof e){"string"==typeof e.views&&(e.views=[e.views]);var t=[],o=this.controller.views;e.views.forEach(function(s,i){e.views=s,t[i]=o.path(e)}),Object.assign(e,{file:t,ready:e.ready}),this.fetch(e)}}),this.urls={},this.urls.load=(e=>{e=e||{};const t=this,o=t.app.controller_name,s=t.app.action_name,i=t.app.parameters;let r=t.urls[o]||!1;if(e.module=turpial.un(e.module,null),"string"==typeof e.module)return void t.view.load(e);if(!1===r)return void t.view.load(e);t.un(r.loadController,!0);let n=t.un(r.loadAction,!0),l=t.un(r.loadParameters,1e3),a=t.un(t.urls[o][s],!1);return"function"==typeof r.self?"function"==typeof a&&!0===n?i.length>l?void r.self(()=>{a(()=>{})}):void r.self(()=>{a(()=>{t.view.load(e)})}):!1===n&&"string"==typeof s?void r.self(()=>{a(()=>{})}):void r.self(()=>{t.view.load(e)}):void 0}),this.historyEvents={},this.URLNoHASH=function(e){return e.split("#")[0]},this.createHistoryEvent=function(e,t){e=this.URLNoHASH(window.location.href)+(e=e||""),this.historyEvents[e]=t},this.createHistoryEvent("",function(){}),this.stateEvent=(()=>{var e=this.historyEvents;"function"==typeof e[this.URLNoHASH(window.location.href)]&&e[this.URLNoHASH(window.location.href)]()}),!0===this.allowStateEvents&&window.addEventListener("popstate",this.stateEvent),!0===e.autoloader&&(window.addEventListener("load",()=>{this.urls.load()}),window.onpopstate=(e=>{this.controller.routes.set(),this.urls.load(),function(){void 0===window.customElements&&Array.prototype.slice.call(this.myComponents).forEach(function(e){this.component.set({tag:e.tag,props:e.props})})}()}))}map(e,t=[]){var o=this.birds[e];if("object"==typeof e?o=e:void 0===o&&(o=this.find(e)),"object"==typeof t){if(void 0===t[0])return o;o=o.children,t.forEach(function(e,s){o=void 0===t[s+1]?o[e]:o[e].children})}return o}createMap(e){var t=(e=this.find(e)).getAttribute("id");if(void 0!==t){var o=document.getElementById(t);this.birds[t]=o}}read(e,t=[]){return this.map(e,t)}selectorApp(e,t=[]){return"object"==typeof t&&!0===Number.isInteger(t[0])?this.map(e,t):t}delete(e){(e=this.find(e)).remove()}update(e,t=null,o="replace-selector",s=!0){if("string"==typeof t)var i=this.render(t),r=t;else i=t;if(null===i){var n=!1;i=t}else n=!0;var l=e;!0===s&&(o="replace-selector");var a=!1,h=l.parentNode;if("before"===o)h.insertBefore(i,l),a=i;else if("after"===o)h.insertBefore(i,l.nextSibling),a=i;else if("replace-selector"===o)h.replaceChild(i,l),a=i;else{if("inner"!==o)return console.warn("error-on-placement"),!1;!0===n?l.innerHTML=r:l.innerText=i,a=l}let d=l;return this.createMap(d),a}insert(e,t,o="inner"){return e=this.find(e),this.update(e,t,o,!1)}render(e){var t=document.createElement("template");return t.innerHTML=e,t=t.content.firstElementChild}mount(e,t){if("string"==typeof t)t=this.render(t);if(null===t)return void console.warn("need to be HTML string or object");let o=(e=this.find(e)).appendChild(t),s=e;return this.createMap(s),o}settings(e){if(void 0===e[0]){var t=[],o=0,s=[];for(var i in e)s.push(e[i]);s.forEach(function(e){t[o++]=e});var r=[];o=0;Object.keys(e).forEach(function(e){r[o++]=e});var n="";o=0;return r.forEach(function(e,o){n+=` ${e}="${t[o]}"`}),n}}createTag(e,t="",o=""){"object"==typeof t&&(t=this.settings(t));let s=`<${e}${t}>`;return s+=o,"br"!==e&&(s+=`</${e}>`),s}html(e,t,o){const s=this.replacement,i=this;if("code"===e&&(o=s(o,"<","&lt;"),o=s(o,">","&gt;"),o=s(o," ","&nbsp;")),void 0===o)o=t,t="";if("object"==typeof o&&void 0!==o[0]){var r="";o.forEach(function(e,t){r+=`${e}`});var n=i.createTag(e,t,r)}else if("object"==typeof o)t=o,n=i.createTag(e,t,o="");else n=i.createTag(e,t,o);return n}el(e,t,o){return this.html(e,t,o)}}
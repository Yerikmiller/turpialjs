/*
  _______ _    _ _____  _____ _____          _             _  _____ 
 |__   __| |  | |  __ \|  __ \_   _|   /\   | |           | |/ ____|
    | |  | |  | | |__) | |__) || |    /  \  | |           | | (___  
    | |  | |  | |  _  /|  ___/ | |   / /\ \ | |       _   | |\___ \ 
    | |  | |__| | | \ \| |    _| |_ / ____ \| |____  | |__| |____) |
    |_|   \____/|_|  \_\_|   |_____/_/    \_\______|  \____/|_____/ 
    * Turpial JS Library V. 1.0.0
    * License: MIT.
    * Copyright Yorman Maricuto, May 2019.
    * @twitter: @MaricutoYorman, @Instagram: maricuto
    * Micro-Library to create web components, multi-fetch elements, append styles, scripts, templating engine JSX
*/
class Turpial{constructor(e={}){this.birds=[],this.un=((e,t="")=>void 0===e?t:e),this.searchStr=((e,t,o=!1)=>{let r=e.search(t);return-1!==r&&(!0!==o||r)}),this.replacement=((e,t,o)=>e.split(t).join(o)),this.find=(e=>"string"==typeof e?document.getElementById(e):e),this.ext=".turpial.js",this.allowStateEvents=this.un(e.allowStateEvents,!1),this.autoloader=this.un(e.autoloader,!1),this.autoloader_folder=this.un(e.autoloader_folder,""),this.cache=this.un(e.cache,"public"),this.public_path=this.un(e.public_path,""),this.core_path=this.un(e.core_path,""),this.folder=this.un(e.core_path,"/turpial/"),this.loader={},this.httpRequests=[],this.loader.show=this.un(e.loaderShow,null),this.loader.hide=this.un(e.loaderHide,null),this.views={},this.statusResources="loaded",this.resources={},this.myComponents=[],this.random_string=(e=>{void 0===e&&(e=6);for(var t="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=o.length,s=0;s<e;s++)t+=o.charAt(Math.floor(Math.random()*r));return t}),this.selectData=((e,t,o,r)=>{r=turpial.un(r,!1);var s="";return e.forEach(function(e,i){if(e[t]==o)return!0===r?void(s=i):void(s=e)}),s}),this.component={applyProps:(e,t)=>{const o=()=>{const o=document.querySelectorAll(e);Array.prototype.slice.call(o).forEach(function(e){t(e)})},r=()=>{if("loading"===this.statusResources)var e=0,t=setInterval(()=>e>6e3?(console.warn("error loading resources and applying components"),void clearInterval(t)):(e+=20,"loaded"===this.statusResources?(clearInterval(t),void o()):void 0),20);else o()};window.addEventListener("load",()=>{r()}),"complete"!==document.readyState||r()},set:e=>{const t=this,o=t.component;var r=e.props,s=e.tag;t.myComponents.push({tag:s,props:r});var i=t.un(e.extends,null);if(null!==i&&(i={extends:i}),void 0===window.customElements)return t.component.olderVerBrow=(()=>{}),void o.applyProps(s,r);void 0===window.customElements.get(s)&&window.customElements.define(s,class extends HTMLElement{constructor(t=e.props){super((e=>{o.applyProps(s,e)})(t))}},i)}},this.view={},this.models={},this.models.sources={},this.controller={},this.urls={},this.filesLoaded={},this.inject=(e=>{for(const t of e)"STYLE"===this.filesLoaded[t].tagName&&(this.filesLoaded[t].innerHTML=this.filesLoaded[t].text),document.head.appendChild(this.filesLoaded[t])}),this.models.fetch=(e=>{let t=this,o=e.type||"script";const r=t.un(e.cancelOnResend,null),s=t.un(e.options,null),i=t.un(e.method,"GET");e.url=e.url||[],e.file=e.file||e.url,e.files=e.files||e.file;var n=e.files;void 0===e.ready&&(e.ready=(()=>{})),"string"==typeof n&&(n=[n]);document.head;const l=[],a=[];let h=[];e.getString=(e=>e.clone().text()),e.fetching=(n=>{void 0!==t.filesLoaded[n]&&"script"===o&&t.filesLoaded[n].remove();var c=new XMLHttpRequest;c.open(i,n,!0);const d=[],u=[];if(null!==s){for(var p in s)u.push(s[p]);Object.keys(s).forEach(function(e,t){d.push([e,u[t]])}),d.forEach(function(e){c.setRequestHeader(e[0],e[1])})}if(c.onload=function(){if(c.status>=200&&c.status<400){var r,s=c.responseText;h.push(s),r="script"===o||"style"===o||"link"===o?o:"script";var i=document.createElement(r);"style"===o?i.type="text/css":"link"===o&&(i.rel="stylesheet",i.media="all",i.href=n),i.text=s,t.filesLoaded[n]=i,l.push(n)}else if("function"==typeof e.onerror&&c.status>=400)return e.onerror(c.status)},c.onerror=function(){t.filesLoaded[n]="",l.push("unloaded:"+n),a.push(n)},!0===r){let o="rq_"+t.un(e.id,t.random_string(4));if(void 0!==t.httpRequests[o])try{t.httpRequests[o].abort()}catch(e){console.warn("unable to cancel request.")}t.httpRequests[o]=c}"POST"!==i?c.send():c.send(e.data)}),t.statusResources="loading",(r=>{for(const t of r)e.fetching(t);var s=0;let i=setInterval(()=>{let n=!1;if(1e4===(s+=70)&&(n=!0,console.warn("Â¡Impossible to load all files.")),l.length!==r.length&&!0!==n);else{if(clearInterval(i),"script"===o||"style"===o||"link"===o)t.inject(r),e.ready();else if("text"===o){var a=[];for(var h of r)a.push(t.filesLoaded[h].innerHTML);e.ready(a)}t.statusResources="loaded"}},70)})(n)}),this.fetch=(e=>this.models.fetch(e)),this.include=(e=>this.models.fetch(e)),this.linkCSS=(e=>{e.type="link";var t=this;e.type="style",e.url=e.url||[],e.file=e.file||e.url,e.files=e.files||e.file;var o=[];return e.files.map(e=>{var r=document.createElement("link");r.setAttribute("media","all"),r.href=e;var s=t.mount(document.head,r);o.push(s)}),e.ready(o),o}),this.includeCSS=(e=>(e.type="style",this.models.fetch(e))),this.controller.views={path:e=>{const t=this.ext;var o=`${this.folder}views/`,r=e.views,s=this.resources,i=r.split("/"),n=o;if(1===i.length){var l=i[0];return n+=`${l}${t}`,s[l]={},n}var a=i.pop(),h=i.pop();l=a;return s[h]={},s[h][l]={},0===i.length?n+=`${h}/${l}${t}`:(i.forEach(function(e){n+=`${e}/`}),n+=`${h}/${l}${t}`),n}},this.view.load=(e=>{e=e||{folder:this.autoloader_folder,ready:()=>{}};const t=this.ext,o=this.app.parameters,r=this.app.controller_name,s=this.app.action_name,i=`${this.folder}${e.folder}${r}`;if(e.module=turpial.un(e.module,null),"index"===r)var n=`${i}${t}`;else if(0===o.length&&"index"!==r&&void 0===s)n=`${i}/index${t}`;else if(0===o.length&&"undefined"!==s)n=`${i}/${s}/index${t}`;else{n=`${i}/${s}`;o.forEach(function(e){n+=`/${e}`}),n+=t}"string"==typeof e.module&&(e.ext=e.ext||t,n=this.core_path+e.module+e.ext);var l={file:n,options:e.options||{},ready:()=>{e.ready()}};"function"==typeof e.error&&(l.error=(t=>{e.error(t)})),this.DataView=l,""!==e.module&&!1!==e.module&&this.fetch(l)}),this.controller.routes={set:()=>{const e=this;e.app={};var t=window.location.href.split("?");let o=(t=(t=t[0]).split("#"))[0].search(e.public_path);if(o>0){var r=(t=t[0].substr(o+e.public_path.length)).split("/"),s=0,i=0;e.app.parameters=[],r.forEach(function(t){""!=t&&(0===s&&(e.app.controller_name=t),1===s?e.app.action_name=t:s>1&&(e.app.parameters[i++]=t),s++)}),void 0===e.app.controller_name&&(e.app.controller_name="index")}else console.warn("bad_public_path_name")},change:e=>{var t=window.location.href,o=(t=(t=(t=(t=t.split("#"))[0]).split("?"))[0]).split("/");o=""===o.pop()?"":"/",!0===this.searchStr(e.path,"http")&&(t=""),window.history.pushState(this.un(e.object),"",this.un(`${t}${o}${e.path}`)),this.controller.routes.set(),this.urls.load(e);let r=this.un(e.title,!1);"string"==typeof r&&(document.title=r)},go:e=>{if("number"==typeof e)window.history.go(e);else if("back"===e)window.history.back();else{if("forward"!==e)return;window.history.forward()}this.controller.routes.set(),this.urls.load()}},this.router=(e=>{"number"!=typeof e&&"string"!=typeof e?(this.controller.routes.change(e),this.stateEvent()):this.controller.routes.go(e)}),this.routes=this.controller.routes.set,this.routes(),this.controller.components={},this.views.get=(e=>{if("object"==typeof e){"string"==typeof e.views&&(e.views=[e.views]);var t=[],o=this.controller.views;e.views.forEach(function(r,s){e.views=r,t[s]=o.path(e)}),Object.assign(e,{file:t,ready:e.ready}),this.fetch(e)}}),this.urls={},this.urls.load=(e=>{e=e||{};const t=this,o=t.app.controller_name,r=t.app.action_name,s=t.app.parameters;let i=t.urls[o]||!1;if(e.module=turpial.un(e.module,null),"string"==typeof e.module)return void t.view.load(e);if(!1===i)return void t.view.load(e);t.un(i.loadController,!0);let n=t.un(i.loadAction,!0),l=t.un(i.loadParameters,1e3),a=t.un(t.urls[o][r],!1);return"function"==typeof i.self?"function"==typeof a&&!0===n?s.length>l?void i.self(()=>{a(()=>{})}):void i.self(()=>{a(()=>{t.view.load(e)})}):!1===n&&"string"==typeof r?void i.self(()=>{a(()=>{})}):void i.self(()=>{t.view.load(e)}):void 0}),this.historyEvents={},this.URLNoHASH=function(e){return e.split("#")[0]},this.createHistoryEvent=function(e,t){e=this.URLNoHASH(window.location.href)+(e=e||""),this.historyEvents[e]=t},this.createHistoryEvent("",function(){}),this.stateEvent=(()=>{var e=this.historyEvents;"function"==typeof e[this.URLNoHASH(window.location.href)]&&e[this.URLNoHASH(window.location.href)]()}),!0===this.allowStateEvents&&window.addEventListener("popstate",this.stateEvent),!0===e.autoloader&&(window.addEventListener("load",()=>{this.urls.load()}),window.onpopstate=(e=>{this.controller.routes.set(),this.urls.load(),function(){void 0===window.customElements&&Array.prototype.slice.call(this.myComponents).forEach(function(e){this.component.set({tag:e.tag,props:e.props})})}()})),this.template=((e,t)=>{return function(e,t){if("object"==typeof(t=t||[])&&!Array.isArray(t)){var o=[];Object.values(t).map((e,r)=>{o.push({[Object.keys(t)[r]]:e})}),t=o}"object"==typeof e&&(e=e.innerHTML);var r=e;return t.forEach(function(t){var o=Object.keys(t),s=Object.values(t);o.forEach(function(t,o){t=`{{ ${t} }}`,e.search(t)>=0&&(r=function(e,t,o){return e.split(t).join(o)}(r,t,s[o]))})}),r}(e,t)})}map(e,t=[]){var o=this.birds[e];if("object"==typeof e?o=e:void 0===o&&(o=this.find(e)),"object"==typeof t){if(void 0===t[0])return o;o=o.children,t.forEach(function(e,r){o=void 0===t[r+1]?o[e]:o[e].children})}return o}createMap(e){var t=(e=this.find(e)).getAttribute("id");if(void 0!==t){var o=document.getElementById(t);this.birds[t]=o}}read(e,t=[]){return this.map(e,t)}selectorApp(e,t=[]){return"object"==typeof t&&!0===Number.isInteger(t[0])?this.map(e,t):t}delete(e){(e=this.find(e)).remove()}update(e,t=null,o="replace-selector",r=!0){if("string"==typeof t)var s=this.render(t),i=t;else s=t;if(null===s){var n=!1;s=t}else n=!0;var l=e;!0===r&&(o="replace-selector");var a=!1,h=l.parentNode;if("before"===o)h.insertBefore(s,l),a=s;else if("after"===o)h.insertBefore(s,l.nextSibling),a=s;else if("replace-selector"===o)h.replaceChild(s,l),a=s;else{if("inner"!==o)return console.warn("error-on-placement"),!1;!0===n?l.innerHTML=i:l.innerText=s,a=l}let c=l;return this.createMap(c),a}insert(e,t,o="inner"){return e=this.find(e),this.update(e,t,o,!1)}render(e){var t=document.createElement("template");return t.innerHTML=e,t=t.content.firstElementChild}mount(e,t){if("string"==typeof t)t=this.render(t);if(null===t)return void console.warn("need to be HTML string or object");let o=(e=this.find(e)).appendChild(t),r=e;return this.createMap(r),o}settings(e){if(void 0===e[0]){var t=[],o=0,r=[];for(var s in e)r.push(e[s]);r.forEach(function(e){t[o++]=e});var i=[];o=0;Object.keys(e).forEach(function(e){i[o++]=e});var n="";o=0;return i.forEach(function(e,o){n+=` ${e}="${t[o]}"`}),n}}createTag(e,t="",o=""){"object"==typeof t&&(t=this.settings(t));let r=`<${e}${t}>`;return r+=o,"br"!==e&&(r+=`</${e}>`),r}html(e,t,o){const r=this.replacement,s=this;if("code"===e&&(o=r(o,"<","&lt;"),o=r(o,">","&gt;"),o=r(o," ","&nbsp;")),void 0===o)o=t,t="";if("object"==typeof o&&void 0!==o[0]){var i="";o.forEach(function(e,t){i+=`${e}`});var n=s.createTag(e,t,i)}else if("object"==typeof o)t=o,n=s.createTag(e,t,o="");else n=s.createTag(e,t,o);return n}el(e,t,o){return this.html(e,t,o)}}
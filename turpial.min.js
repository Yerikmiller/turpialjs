/*
 *  Turpial JS Library V. 1.0.0
 *  Copyright Yorman Maricuto, May 2019.  
 *  License MIT.
 *  Social Media/Contact:
 *  @twitter: @MaricutoYorman
 *  @Instagram: maricuto
 *  @email: yerikmiller@gmail.com
 *  @number: +584267886875
 *  @github: yerikmiller
 *  @project: guide | github.
 *  Micro Library to create web components with a simple template engine for user interfaces (UI).
 *  Easy XHR connections (POST & GET), inject Scripts and CSS whenever you want and make XHR requests.
 *  Turpial: The Venezuela's national bird.
 *
 *  MADE IN: V E N E Z U E L A.
 *
*/
class Turpial{constructor(e={}){this.birds=[],this.un=((e,t="")=>void 0===e?t:e),this.searchStr=((e,t,s=!1)=>{let r=e.search(t);return-1!==r&&(!0!==s||r)}),this.replacement=((e,t,s)=>e.split(t).join(s)),this.find=(e=>"string"==typeof e?document.getElementById(e):e),this.ext=".turpial.js",this.autoloader=this.un(e.autoloader,!1),this.autoloader_folder=this.un(e.autoloader_folder,""),this.cache=this.un(e.cache,"public"),this.public_path=this.un(e.public_path,""),this.core_path=this.un(e.core_path,""),this.folder=this.un(e.core_path,"/turpial/"),this.loader={},this.loader.show=this.un(e.loaderShow,null),this.loader.hide=this.un(e.loaderHide,null),this.views={},this.statusResources="loaded",this.resources={},this.myComponents=[],this.component={applyProps:(e,t)=>{const s=()=>{const s=document.querySelectorAll(e);Array.prototype.slice.call(s).forEach(function(e){t(e)})},r=()=>{if("loading"===this.statusResources)var e=0,t=setInterval(()=>e>6e3?(console.warn("error loading resources and applying components"),void clearInterval(t)):(e+=20,"loaded"===this.statusResources?(clearInterval(t),void s()):void 0),20);else s()};window.addEventListener("load",()=>{r()}),"complete"!==document.readyState||r()},set:e=>{const t=this,s=t.component;var r=e.props,o=e.tag;t.myComponents.push({tag:o,props:r});var i=t.un(e.extends,null);if(null!==i&&(i={extends:i}),void 0===window.customElements)return t.component.olderVerBrow=(()=>{}),void s.applyProps(o,r);void 0===window.customElements.get(o)&&window.customElements.define(o,class extends HTMLElement{constructor(t=e.props){super((e=>{s.applyProps(o,e)})(t))}},i)}},this.view={},this.models={},this.models.sources={},this.controller={},this.urls={},this.filesLoaded={},this.inject=(e=>{for(const t of e)"STYLE"===this.filesLoaded[t].tagName&&(this.filesLoaded[t].innerHTML=this.filesLoaded[t].text),document.head.appendChild(this.filesLoaded[t])}),this.models.fetch=(e=>{let t=this,s=e.type||"script";const r=t.un(e.options,null),o=t.un(e.method,"GET");e.url=e.url||[],e.file=e.file||e.url,e.files=e.files||e.file;var i=e.files;void 0===e.ready&&(e.ready=(()=>{})),"string"==typeof i&&(i=[i]);document.head;const n=[];let l=[];e.getString=(e=>e.clone().text()),e.fetching=(i=>{void 0!==t.filesLoaded[i]&&"script"===s&&t.filesLoaded[i].remove();var a=new XMLHttpRequest;a.open(o,i,!0);const c=[],h=[];if(null!==r){for(var d in r)h.push(r[d]);Object.keys(r).forEach(function(e,t){c.push([e,h[t]])}),c.forEach(function(e){a.setRequestHeader(e[0],e[1])})}a.onload=function(){if(a.status>=200&&a.status<400){var r,o=a.responseText;l.push(o),r="script"===s||"style"===s||"link"===s?s:"script";var c=document.createElement(r);"style"===s?c.type="text/css":"link"===s&&(c.rel="stylesheet",c.media="all",c.href=i),c.text=o,t.filesLoaded[i]=c,n.push(i)}else if("function"==typeof e.onerror&&a.status>=400)return e.onerror(a.status)},"POST"!==o?a.send():a.send(e.data)}),t.statusResources="loading",(r=>{for(const t of r)e.fetching(t);var o=0;let i=setInterval(()=>{let l=!1;if(1e4===(o+=70)&&(l=!0,console.warn("Â¡Impossible to load all files.")),n.length!==r.length&&!0!==l);else{if(clearInterval(i),"script"===s||"style"===s||"link"===s)t.inject(r),e.ready();else if("text"===s){var a=[];for(var c of r)a.push(t.filesLoaded[c].innerHTML);e.ready(a)}t.statusResources="loaded"}},70)})(i)}),this.fetch=(e=>this.models.fetch(e)),this.include=(e=>this.models.fetch(e)),this.linkCSS=(e=>(e.type="link",this.models.fetch(e))),this.includeCSS=(e=>(e.type="style",this.models.fetch(e))),this.controller.views={path:e=>{const t=this.ext;var s=`${this.folder}views/`,r=e.views,o=this.resources,i=r.split("/"),n=s;if(1===i.length){var l=i[0];return n+=`${l}${t}`,o[l]={},n}var a=i.pop(),c=i.pop();l=a;return o[c]={},o[c][l]={},0===i.length?n+=`${c}/${l}${t}`:(i.forEach(function(e){n+=`${e}/`}),n+=`${c}/${l}${t}`),n}},this.view.load=((e={folder:this.autoloader_folder,ready:()=>{}})=>{const t=this.ext,s=this.app.parameters,r=this.app.controller_name,o=this.app.action_name,i=`${this.folder}${e.folder}${r}`;if("index"===r)var n=`${i}${t}`;else if(0===s.length&&"index"!==r&&void 0===o)n=`${i}/index${t}`;else if(0===s.length&&"undefined"!==o)n=`${i}/${o}/index${t}`;else{n=`${i}/${o}`;s.forEach(function(e){n+=`/${e}`}),n+=t}var l={file:n,ready:()=>{e.ready()}};"function"==typeof e.error&&(l.error=(t=>{e.error(t)})),this.fetch(l),this.DataView=l}),this.controller.routes={set:()=>{const e=this;e.app={};var t=window.location.href.split("?");let s=(t=(t=t[0]).split("#"))[0].search(e.public_path);if(s>0){var r=(t=t[0].substr(s+e.public_path.length)).split("/"),o=0,i=0;e.app.parameters=[],r.forEach(function(t){""!=t&&(0===o&&(e.app.controller_name=t),1===o?e.app.action_name=t:o>1&&(e.app.parameters[i++]=t),o++)}),void 0===e.app.controller_name&&(e.app.controller_name="index")}else console.warn("bad_public_path_name")},change:e=>{var t=window.location.href,s=(t=(t=(t=(t=t.split("#"))[0]).split("?"))[0]).split("/");s=""===s.pop()?"":"/",!0===this.searchStr(e.path,"http")&&(t=""),window.history.pushState(this.un(e.object),"",this.un(`${t}${s}${e.path}`)),this.controller.routes.set(),this.urls.load();let r=this.un(e.title,!1);"string"==typeof r&&(document.title=r)},go:e=>{if("number"==typeof e)window.history.go(e);else if("back"===e)window.history.back();else{if("forward"!==e)return;window.history.forward()}this.controller.routes.set(),this.urls.load()}},this.router=(e=>{"number"!=typeof e&&"string"!=typeof e?this.controller.routes.change(e):this.controller.routes.go(e)}),this.routes=this.controller.routes.set,this.routes(),this.controller.components={},this.views.get=(e=>{if("object"==typeof e){"string"==typeof e.views&&(e.views=[e.views]);var t=[],s=this.controller.views;e.views.forEach(function(r,o){e.views=r,t[o]=s.path(e)}),Object.assign(e,{file:t,ready:e.ready}),this.fetch(e)}}),this.urls={},this.urls.load=(()=>{const e=this,t=e.app.controller_name,s=e.app.action_name,r=e.app.parameters;let o=e.un(e.urls[t],!1);if(!1===o)return void e.view.load();e.un(o.loadController,!0);let i=e.un(o.loadAction,!0),n=e.un(o.loadParameters,1e3),l=e.un(e.urls[t][s],!1);return"function"==typeof o.self?"function"==typeof l&&!0===i?r.length>n?void o.self(()=>{l(()=>{})}):void o.self(()=>{l(()=>{e.view.load()})}):!1===i&&"string"==typeof s?void o.self(()=>{l(()=>{})}):void o.self(()=>{e.view.load()}):void 0}),!0===e.autoloader&&(window.addEventListener("load",()=>{this.urls.load()}),window.onpopstate=(e=>{this.controller.routes.set(),this.urls.load(),function(){void 0===window.customElements&&Array.prototype.slice.call(this.myComponents).forEach(function(e){this.component.set({tag:e.tag,props:e.props})})}()}))}map(e,t=[]){var s=this.birds[e];if("object"==typeof e?s=e:void 0===s&&(s=this.find(e)),"object"==typeof t){if(void 0===t[0])return s;s=s.children,t.forEach(function(e,r){s=void 0===t[r+1]?s[e]:s[e].children})}return s}createMap(e){var t=(e=this.find(e)).getAttribute("id");if(void 0!==t){var s=document.getElementById(t);this.birds[t]=s}}read(e,t=[]){return this.map(e,t)}selectorApp(e,t=[]){return"object"==typeof t&&!0===Number.isInteger(t[0])?this.map(e,t):t}delete(e){(e=this.find(e)).remove()}update(e,t=null,s="replace-selector",r=!0){if("string"==typeof t)var o=this.render(t),i=t;else o=t;if(null===o){var n=!1;o=t}else n=!0;var l=e;!0===r&&(s="replace-selector");var a=!1,c=l.parentNode;if("before"===s)c.insertBefore(o,l),a=o;else if("after"===s)c.insertBefore(o,l.nextSibling),a=o;else if("replace-selector"===s)c.replaceChild(o,l),a=o;else{if("inner"!==s)return console.warn("error-on-placement"),!1;!0===n?l.innerHTML=i:l.innerText=o,a=l}let h=l;return this.createMap(h),a}insert(e,t,s="inner"){return e=this.find(e),this.update(e,t,s,!1)}render(e){var t=document.createElement("template");return t.innerHTML=e,t=t.content.firstElementChild}mount(e,t){if("string"==typeof t)t=this.render(t);if(null===t)return void console.warn("need to be HTML string or object");let s=(e=this.find(e)).appendChild(t),r=e;return this.createMap(r),s}settings(e){if(void 0===e[0]){var t=[],s=0,r=[];for(var o in e)r.push(e[o]);r.forEach(function(e){t[s++]=e});var i=[];s=0;Object.keys(e).forEach(function(e){i[s++]=e});var n="";s=0;return i.forEach(function(e,s){n+=` ${e}="${t[s]}"`}),n}}createTag(e,t="",s=""){"object"==typeof t&&(t=this.settings(t));let r=`<${e}${t}>`;return r+=s,"br"!==e&&(r+=`</${e}>`),r}html(e,t,s){const r=this.replacement,o=this;if("code"===e&&(s=r(s,"<","&lt;"),s=r(s,">","&gt;"),s=r(s," ","&nbsp;")),void 0===s)s=t,t="";if("object"==typeof s&&void 0!==s[0]){var i="";s.forEach(function(e,t){i+=`${e}`});var n=o.createTag(e,t,i)}else if("object"==typeof s)t=s,n=o.createTag(e,t,s="");else n=o.createTag(e,t,s);return n}el(e,t,s){return this.html(e,t,s)}}
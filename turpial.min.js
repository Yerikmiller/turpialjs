/*
 *	Turpial JS Templating Engine Library V. 1.0.0
 *	Copyright Yorman Maricuto, May 2019.  
 * 	License MIT.
 * 	Social Media/Contact:
 *	@twitter: @MaricutoYorman
 *	@Instagram: maricuto
 *	@email: yerikmiller@gmail.com
 *	@number: +584267886875
 *	@github: yerikmiller
 * 	@project: guide | github.
 *	Micro Framework to create web components and a templating engine for user interfaces (UI).
 *	Turpial: The Venezuela's national bird.
 *
 * 	MADE IN: V E N E Z U E L A.
 * 	@Minified Version. V. 1.0.0
 *
*/
class Turpial{constructor(e={}){this.birds=[],this.un=((e,t="")=>void 0===e?t:e),this.searchStr=((e,t,i=!1)=>{let r=e.search(t);return-1!==r&&(!0!==i||r)}),this.replacement=((e,t,i)=>e.split(t).join(i)),this.find=(e=>"string"==typeof e?document.getElementById(e):e),this.autoloader=this.un(e.autoloader,!1),this.autoloader_folder=this.un(e.autoloader_folder,""),this.cache=this.un(e.cache,"default"),this.public_path=this.un(e.public_path,""),this.core_path=this.un(e.core_path,""),this.folder=this.un(e.core_path,"/turpial/"),this.loader={},this.loader.show=this.un(e.loaderShow,null),this.loader.hide=this.un(e.loaderHide,null),this.views={},this.resources={},this.Pro=(e=>new Promise(t=>{e();setInterval(()=>{console.log(e)},500)})),this.component={set:e=>{let t=e.tag;var i=this.un(e.extends,null);void 0===window.customElements.get(t)&&(null!==i&&(i={extends:i}),window.customElements.define(t,class extends HTMLElement{constructor(i=e.props){super((e=>{var i=t=>{return[...document.getElementsByTagName(t)].forEach(function(t){e(t)}),"ready"};if(window.addEventListener("load",()=>i(t)),"complete"===document.readyState)return i(t)})(i))}},i))}},this.view={application:this},this.models={},this.models.sources={},this.controller={},this.urls={},this.filesLoaded={},this.inject=(async e=>new Promise(t=>{for(const t of e)document.head.appendChild(this.filesLoaded[t])})),this.models.fetch=(e=>{let t=this.un(e.type,"script");const i=this.un(e.options,{cache:this.cache});if(void 0===e.ready&&(e.ready=(()=>{})),"string"==typeof e.file)var r=[e.file];else r=e.file;let s=this;document.head;const o=[];let n=[];e.getString=(e=>e.clone().text()),e.fetching=(async r=>{void 0!==s.filesLoaded[r]&&"script"===t&&s.filesLoaded[r].remove(),window.fetch(r,i).then(t=>{if("function"==typeof e.error&&200!==t.status)return e.error(t.status);200===t.status&&e.getString(t).then(e=>{n.push(e);var t=document.createElement("script");t.text=e,s.filesLoaded[r]=t,o.push(r)})})}),(i=>{for(const t of i)e.fetching(t);var r=0;let l=setInterval(()=>{let a=!1;if(1e4===(r+=70)&&(a=!0,console.warn("Â¡Impossible to load all files.")),o.length===i.length||!0===a){if(clearInterval(l),"script"===t)return s.inject(i),void e.ready();if("text"===t)return void e.ready(n)}},70)})(r)}),this.fetch=(e=>this.models.fetch(e)),this.include=(e=>this.models.fetch(e)),this.controller.views={application:this,folder:`${this.folder}views/`,ext:".turpial.js",path(e){var t=e.views.split("/"),i=this.folder;if(1===t.length){var r=t[0];return i+=`${r}${this.ext}`,this.application.resources[r]={},i}var s=t.pop(),o=t.pop();r=s;return this.application.resources[o]={},this.application.resources[o][r]={},0===t.length?i+=`${o}/${r}${this.ext}`:(t.forEach(function(e){i+=`${e}/`}),i+=`${o}/${r}${this.ext}`),i}},this.view.load=((e={folder:this.autoloader_folder,ready:()=>{}})=>{const t=".turpial.js",i=this.app.parameters,r=this.app.controller_name,s=this.app.action_name,o=`${this.folder}${e.folder}${r}`;if("index"===r)var n=`${o}${t}`;else if(0===i.length&&"index"!==r&&void 0===s)n=`${o}/index${t}`;else if(0===i.length&&"undefined"!==s)n=`${o}/${s}/index${t}`;else{n=`${o}/${s}`;i.forEach(function(e){n+=`/${e}`}),n+=t}var l={file:n,ready:()=>{e.ready()}};"function"==typeof e.error&&(l.error=(t=>{e.error(t)})),this.fetch(l),this.DataView=l}),this.controller.routes={set:()=>{var e=this;e.app={};var t=window.location.href.split("?");let i=(t=(t=t[0]).split("#"))[0].search(this.public_path);if(i>0){var r=(t=t[0].substr(i+this.public_path.length)).split("/"),s=0,o=0;e.app.parameters=[],r.forEach(function(t){""!=t&&(0===s&&(e.app.controller_name=t),1===s?e.app.action_name=t:s>1&&(e.app.parameters[o++]=t),s++)}),void 0===e.app.controller_name&&(e.app.controller_name="index")}else console.warn("bad_public_path_name")},change:e=>{var t=window.location.href,i=(t=(t=(t=(t=t.split("#"))[0]).split("?"))[0]).split("/");i=""===i.pop()?"":"/",!0===this.searchStr(e.path,"http")&&(t=""),window.history.pushState(this.un(e.object),"",this.un(`${t}${i}${e.path}`)),this.controller.routes.set(),this.urls.load();let r=this.un(e.title,!1);"string"==typeof r&&(document.title=r)},go:e=>{if("number"==typeof e)window.history.go(e);else if("back"===e)window.history.back();else{if("forward"!==e)return;window.history.forward()}this.controller.routes.set(),this.urls.load()}},this.router=(e=>{"number"!=typeof e&&"string"!=typeof e?this.controller.routes.change(e):this.controller.routes.go(e)}),this.routes=this.controller.routes.set,this.routes(),this.controller.components={},this.views.get=(e=>{if("object"==typeof e){"string"==typeof e.views&&(e.views=[e.views]);var t=[],i=this.controller.views;e.views.forEach(function(r,s){e.views=r,t[s]=i.path(e)}),this.fetch({file:t,ready:e.ready})}}),this.urls={},this.urls.load=(()=>{const e=this.app.controller_name,t=this.app.action_name,i=this.app.parameters;let r=this.un(this.urls[e],!1);if(!1===r)return void this.view.load();this.un(r.loadController,!0);let s=this.un(r.loadAction,!0),o=this.un(r.loadParameters,1e3),n=this.un(this.urls[e][t],!1);return"function"==typeof r.self?"function"==typeof n&&!0===s?i.length>o?void r.self(()=>{n(()=>{})}):void r.self(()=>{n(()=>{this.view.load()})}):!1===s&&"string"==typeof t?void r.self(()=>{n(()=>{})}):void r.self(()=>{this.view.load()}):void 0}),!0===e.autoloader&&(window.addEventListener("load",()=>{this.urls.load()}),window.onpopstate=(e=>{this.controller.routes.set(),this.urls.load()}))}map(e,t=[]){var i=this.birds[e];if("object"==typeof e?i=e:void 0===i&&(i=this.find(e)),"object"==typeof t){if(void 0===t[0])return i;i=i.children,t.forEach(function(e,r){i=void 0===t[r+1]?i[e]:i[e].children})}return i}createMap(e){var t=(e=this.find(e)).getAttribute("id");if(void 0!==t){var i=document.getElementById(t);this.birds[t]=i}}read(e,t=[]){return this.map(e,t)}selectorApp(e,t=[]){return"object"==typeof t&&!0===Number.isInteger(t[0])?this.map(e,t):t}delete(e){(e=this.find(e)).remove()}update(e,t=null,i="replace-selector",r=!0){if("string"==typeof t)var s=this.render(t),o=t;else s=t;if(null===s){var n=!1;s=t}else n=!0;var l=e;!0===r&&(i="replace-selector");var a=!1,h=l.parentNode;if("before"===i)h.insertBefore(s,l),a=s;else if("after"===i)h.insertBefore(s,l.nextSibling),a=s;else if("replace-selector"===i)h.replaceChild(s,l),a=s;else{if("inner"!==i)return console.warn("error-on-placement"),!1;!0===n?l.innerHTML=o:l.innerText=s,a=l}let c=l;return this.createMap(c),a}insert(e,t,i="inner"){return e=this.find(e),this.update(e,t,i,!1)}render(e){var t=document.createElement("template");return t.innerHTML=e,t=t.content.firstElementChild}mount(e,t){if("string"==typeof t)t=this.render(t);if(null===t)return void console.warn("need to be HTML string or object");let i=(e=this.find(e)).appendChild(t),r=e;return this.createMap(r),i}settings(e){if(void 0!==e[0])return"";var t=[],i=0;Object.values(e).forEach(function(e){t[i++]=e});var r=[];i=0;Object.keys(e).forEach(function(e){r[i++]=e});var s="";i=0;return r.forEach(function(e,i){s+=` ${e}="${t[i]}"`}),s}createTag(e,t="",i=""){if("object"==typeof t)t=this.settings(t);let r=`<${e}${t}>`;return r+=i,"br"!==e&&(r+=`</${e}>`),r}html(e,t,i){"code"===e&&(i=this.replacement(i,"<","&lt;"),i=this.replacement(i,">","&gt;"),i=this.replacement(i," ","&nbsp;"));if(void 0===i)i=t,t="";if("object"==typeof i&&void 0!==i[0]){var r="";i.forEach(function(e,t){r+=`${e}`});var s=this.createTag(e,t,r)}else if("object"==typeof i)t=i,s=this.createTag(e,t,i="");else s=this.createTag(e,t,i);return s}el(e,t,i){return this.html(e,t,i)}}